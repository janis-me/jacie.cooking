---
import { getCollection } from 'astro:content';

import Layout from '#layouts/Main.astro';

import './index.css';

const recipes = await getCollection('recipes');

// Extract all unique tags from recipes
const allTags = [...new Set(recipes.flatMap(recipe => recipe.data.tags))].sort();
---

<Layout title="recipes - jacie.cooking" className="recipes-page">
  <section class="recipes-header">
    <h1 class="recipes-title">Alle Rezepte</h1>
    <p class="recipes-subtitle">Entdecke leckere Rezepte nach deinem Geschmack</p>
  </section>

  <section class="filter-section">
    <div class="filter-container">
      <h2 class="filter-title">Filter nach Tags:</h2>
      <div class="tags-container">
        <button class="tag-button" data-tag="all"> Alle </button>
        {
          allTags.map(tag => (
            <button class="tag-button" data-tag={tag}>
              {tag}
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <section class="recipes-content">
    {
      recipes.map(recipe => (
        <article
          class="recipe-card"
          style={`background-image: url(${recipe.data.coverImage})`}
          data-tags={recipe.data.tags.join(',')}
        >
          <a href={`/recipes/${recipe.id}`} class="recipe-link">
            <h2 class="recipe-title">{recipe.data.title}</h2>
            {recipe.data.description && <p class="recipe-description">{recipe.data.description}</p>}
            <div class="recipe-tags">
              {recipe.data.tags.map(tag => (
                <span class="recipe-tag">{tag}</span>
              ))}
            </div>
          </a>
        </article>
      ))
    }
  </section>

  <div class="no-results" style="display: none;">
    <p>Keine Rezepte mit diesem Tag gefunden.</p>
  </div>

  <script>
    // Filter functionality - fully client-side
    const tagButtons = document.querySelectorAll('.tag-button');
    const recipeCards = document.querySelectorAll('.recipe-card');
    const noResults = document.querySelector('.no-results');

    function filterRecipes(selectedTag: string) {
      let visibleCount = 0;

      recipeCards.forEach(card => {
        const cardElement = card as HTMLElement;
        const cardTags = cardElement.dataset.tags?.split(',') || [];

        if (selectedTag === 'all' || cardTags.includes(selectedTag)) {
          cardElement.style.display = '';
          visibleCount++;
        } else {
          cardElement.style.display = 'none';
        }
      });

      // Show/hide no results message
      if (noResults) {
        (noResults as HTMLElement).style.display = visibleCount === 0 ? 'block' : 'none';
      }

      // Update URL without reload
      const url = new URL(window.location.href);
      if (selectedTag === 'all') {
        url.searchParams.delete('tag');
      } else {
        url.searchParams.set('tag', selectedTag);
      }
      window.history.pushState({}, '', url);
    }

    function getInitialTagFromURL(): string {
      // Read tag from URL on the client side
      const params = new URLSearchParams(window.location.search);
      return params.get('tag') || 'all';
    }

    function initializeFilters() {
      const initialTag = getInitialTagFromURL();

      // Set initial active state
      tagButtons.forEach(button => {
        const tag = button.getAttribute('data-tag') || 'all';
        if (tag === initialTag) {
          button.classList.add('active');
        }

        button.addEventListener('click', () => {
          // Remove active class from all buttons
          tagButtons.forEach(btn => btn.classList.remove('active'));

          // Add active class to clicked button
          button.classList.add('active');

          // Filter recipes
          filterRecipes(tag);
        });
      });

      // Apply initial filter if tag is in URL
      if (initialTag !== 'all') {
        filterRecipes(initialTag);
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeFilters);
    } else {
      initializeFilters();
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', () => {
      const tag = getInitialTagFromURL();

      // Update active button
      tagButtons.forEach(button => {
        button.classList.remove('active');
        if (button.getAttribute('data-tag') === tag) {
          button.classList.add('active');
        }
      });

      // Apply filter
      filterRecipes(tag);
    });
  </script>
</Layout>
